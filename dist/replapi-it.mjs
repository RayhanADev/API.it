import e,{appendFileSync as t}from"fs";import r from"path";import{findIndex as s,assign as a}from"lodash-es";import i from"rss-url-parser";import{cosmiconfigSync as n,defaultLoaders as o}from"cosmiconfig";import{lightfetch as l}from"lightfetch-node";import d from"node-html-parser";const p={username:"",captcha:{token:""},endpoints:{gql:"",restful:"",login:""},markdown:{length:"",removeMarkdown:""},previewCount:{comments:""},experimentalFeatures:"",createDatabaseFlag:"",statsForNerds:""},c=n("replapi",{searchPlaces:["package.json",".replapirc",".replapirc.json",".replapirc.yaml",".replapirc.yml",".replapirc.js",".replapirc.cjs","replapi.config.js","replapi.config.cjs","replapi.config.mjs"],loaders:{defaultLoaders:o,".mjs":async e=>await import(e)}}).search();null!==c&&a(p,c.config);const g={initVariables:p,roleAttributes:{id:"",name:"",key:"",tagline:""},languageAttributes:{id:"",displayName:"",key:"",category:"",tagline:"",icon:"",isNew:""},organizationAttributes:{id:"",name:"",country:"",postalCode:"",state:"",city:"",googlePlaceId:"",timeCreated:"",timeUpdated:"",timeDeleted:"",time_created:""},subscriptionAttributes:{id:"",userId:"",customerId:"",planId:"",timeUpdated:"",timeCreated:"",timeDeleted:""},userAttributes:{id:"",username:"",firstName:"",lastName:"",bio:"",isVerified:"",displayName:"",fullName:"",url:"",isLoggedIn:"",isSubscribed:"",timeCreated:"",isBannedFromBoards:"",karma:"",isHacker:"",image:""},boardAttributes:{id:"",name:"",description:"",slug:"",cta:"",titleCta:"",bodyCta:"",template:"",buttonCta:"",color:"",replRequired:"",isLocked:"",isAnswerable:"",isPrivate:"",timeCreated:"",timeUpdated:"",url:"",canPost:""},tagAttributes:{id:"",replCount:"",replsTaggedTodayCount:"",creatorCount:"",isTrending:""},replAttributes:{id:"",language:"",isRenamed:"",isProject:"",isPrivate:"",isStarred:"",isAlwaysOn:"",isBoosted:"",title:"",slug:"",description:"",timeCreated:"",timeUpdated:"",isOwner:"",pinnedToProfile:"",folderId:"",folder:{args:[],items:{id:"",name:""}},files:"",size:"",url:"",url:[{propOverride:!0,lite:!0},"liteUrl"],hostedUrl:"",hostedUrl:[{propOverride:!0,dotty:!0},"dottyUrl"],hostedUrl:[{propOverride:!0,protocol:"WSS"},"wssUrl"],terminalUrl:"",runCount:"",publicForkCount:"",imageUrl:"",reactions:{args:[],items:{id:"",type:"",count:""}},origin:{args:[],items:{url:""}},ioTests:{args:[],items:{id:"",name:"",template:{args:[],items:{id:""}}}},hasUnitTesting:"",unitTests:{args:[],items:{tests:{args:[],items:{id:"",name:"",code:""}},meta:{args:[],items:{imports:"",setup:"",tearDown:""}}}}},replCommentAttributes:{id:"",body:"",timeCreated:"",timeUpdated:"",canEdit:"",canComment:""},commentAttributes:{id:"",body:"",voteCount:"",timeCreated:"",timeUpdated:"",url:"",isAuthor:"",canEdit:"",canVote:"",canComment:"",hasVoted:"",canReport:"",hasReported:"",isAnswer:"",canSelectAsAnswer:"",canUnselectAsAnswer:"",preview:[{propOverride:!0,length:p.markdown.length||150,removeMarkdown:p.markdown.removeMarkdown||!0}]},postAttributes:{id:"",title:"",body:"",showHosted:"",voteCount:"",commentCount:"",isPinned:"",isLocked:"",timeCreated:"",timeUpdated:"",url:"",isAnnouncement:"",isAuthor:"",canEdit:"",canComment:"",canVote:"",canPin:"",canSetType:"",canChangeBoard:"",canLock:"",hasVoted:"",canReport:"",hasReported:"",isAnswerable:"",tutorialPages:"",preview:[{propOverride:!0,length:p.markdown.length||150,removeMarkdown:p.markdown.removeMarkdown||!0}]},graphql:`${p.endpoints.gql||"https://replit.com/graphql"}`,login:`${p.endpoints.login||"https://replit.com/login"}`,restful:`${p.endpoints.restful||"https://replit.com"}`};function u(e){return Object.prototype.toString.call(e).replace(/^\[object\s+([a-z]+)\]$/i,"$1").toLowerCase()}function m(e,t=1){let r="",s="";for(let e=t;e>0;e-=1)s+="\t";for(const[a,i]of Object.entries(e))switch(u(i)){case"string":r+=`${s}${a}\n`;break;case"array":{let e="";i[0]&&!0===i[0].propOverride?(delete i[0].propOverride,e=Object.entries(i[0]||{}).join("* ").replace(/,/g,": ").replace(/\*/g,",")):e=Object.entries(i[0]||{}).join("* ").replace(/,/g,": $").replace(/\*/g,",");const t=i[1];r+=`${s}${t?`${t}: `:""}${a}${e?`(${e})`:""}\n`;break}case"object":{let e="";i.args[0]&&!0===i.args[0].propOverride?(delete i.args[0].propOverride,e=Object.entries(i.args[0]||{}).join("* ").replace(/,/g,": ").replace(/\*/g,",")):e=Object.entries(i.args[0]||{}).join("* ").replace(/,/g,": $").replace(/\*/g,",");const n=i.args[1];r+=`${s}${n?`${n}: `:""}${a}${i.args[0]?`(${e})`:""} {\n${m(i.items,t+1)}\n${s}}\n`;break}default:throw new Error("Unknown type when generating property string.")}return r.slice(0,-1)}function h(e,t,r){const s=function(e){let t="";if(Object.keys(e).length>0)for(const[r,s]of Object.entries(e))t+=`$${r}: ${s},`;return Object.keys(e).length>0?"("+t.slice(0,-1)+")":""}(t),a=m(r);return"query __QUERY_NAME____QUERY_VARIABLES__ {\n__QUERY_PROPERTIES__\n}".replace(/__QUERY_NAME__/,e).replace(/__QUERY_VARIABLES__/,s).replace(/__QUERY_PROPERTIES__/,a)}const f={"Content-Type":"application/json",Accept:"application/json",Connection:"keep-alive","X-Requested-With":"the ReplAPI.it Project",Referrer:"https://replit.com/",Origin:"https://replit.com/"};async function b({name:e,variables:r,items:s},a={}){const i=function(e,t,r){const s=Object.fromEntries(Object.entries(t).map((([e,t])=>[e,t[0]]))),a=Object.fromEntries(Object.entries(t).map((([e,t])=>[e,t[1]])));return{query:h(e,s,r),variables:JSON.stringify(a)}}(e,r,s);if(!0===a.authRequired){if(!global.cookies)throw new Error("ReplAPI.it Error: You are not logged in! Please use the Login class to set your login.");if(!["RayhanADev","ReplAPIit"].includes(g.initVariables.username)||!["RayhanADev","ReplAPIit"].includes(process.env.REPL_OWNER))throw new Error("ReplAPI.it Error: This user is not whitelisted. To gain access to the whitelist contact RayhanADev.");f.cookie="connect.sid="+global.cookies,i.captcha=g.initVariables.captcha.token,i.clientVersion="7561851",i.format="pbuf",i.hCaptchaSiteKey="473079ba-e99f-4e25-a635-e9b661c7dd3e"}const n=await l(g.graphql,{body:i,headers:f,method:"POST"});try{const e=n.toJSON();if(e.errors&&!0===g.initVariables.statsForNerds){const r=`--- ReplAPI.it Stats for Nerds ---\nThis message was autogenerated on ${(new Date).toFormattedString()}\nError Message: Replit GraphQL Errors\nAdditional Information:\nResponse: ${JSON.stringify(e)}\n${i.query}\n${i.variables}\n`;t("./replapi-it--debug.log",r)}return e}catch(e){if(!0===g.initVariables.statsForNerds){const r=`--- ReplAPI.it Stats for Nerds ---\nThis message was autogenerated on ${(new Date).toFormattedString()}\nError Message: ${e.message}\nAdditional Information:\n${n.toText()}\n`;t("./replapi-it--debug.log",r)}throw new Error("ReplAPI.it Error: Could not parse response data. This is likely because of some Replit error, please open an issue on the main Repository to let us know!")}}String.prototype.padLeft=function(e,t){return new Array(e-this.length+1).join(t||" ")+this},Date.prototype.toFormattedString=function(){return[String(this.getMonth()+1).padLeft(2,"0"),String(this.getDate()).padLeft(2,"0"),String(this.getFullYear()).substr(2,2)].join("/")+" "+[String(this.getHours()).padLeft(2,"0"),String(this.getMinutes()).padLeft(2,"0")].join(":")};class w{async runGraphQL(e,r){const s=await b(e,r);if(s.errors){if(!0===g.initVariables.statsForNerds){const e=`--- ReplAPI.it Stats for Nerds ---\nThis message was autogenerated on ${(new Date).toFormattedString()}\nError Message: Replit GraphQL Errors\nAdditional Information:\n${JSON.stringify(s)}\n`;t("./replapi-it--debug.log",e)}throw new Error(`\nReplit GraphQL Errors:${s.errors.map((e=>`\n\t- ${e.message}`))}\n`)}return s}}async function y(){const e=await l("https://replit.com/",{method:"GET",headers:{"X-Requested-With":"ReplAPI.it",Referrer:"https://replit.com/"}}).then((e=>e.toText())),t=d.parse(e,{lowerCaseTagName:!1,comment:!1,blockTextElements:{script:!0,noscript:!0,style:!0,pre:!0}});return JSON.parse(Buffer.from(t.childNodes[1].childNodes[0].childNodes[1].childNodes[0].rawText.split("'")[1].split("'")[0],"base64").toString())}const E={Blog:class{async blogData(){const e=await i("https://blog.replit.com/feed.xml"),{title:t,description:r,link:s,xmlUrl:a}=e[0].meta;return{title:t,description:r,link:s,xmlUrl:a}}async blogItem(e){const t=(await i("https://blog.replit.com/feed.xml")).map((e=>(delete e.meta,delete e["rss:@"],delete e["rss:title"],delete e["rss:guid"],delete e["rss:description"],delete e["rss:pubDate"],delete e["rss:pubdate"],delete e["@"],delete e["#"],e)));return t[s(t,["guid",e])]}async blogItems(e="newest",t=10){const r=(await i("https://blog.replit.com/feed.xml")).map((e=>(delete e.meta,delete e["rss:@"],delete e["rss:title"],delete e["rss:guid"],delete e["rss:description"],delete e["rss:pubDate"],delete e["rss:pubdate"],delete e["@"],delete e["#"],e)));"oldest"===e&&r.reverse();return r.slice(0,t)}},Board:class extends w{constructor(e){super(),this.slug=e}async boardData(){const{slug:e}=this,t={boardBySlug:{args:[{slug:"slug"}],items:{...g.boardAttributes}}},r={slug:["String!",e]},s=await this.runGraphQL({name:"BoardData",variables:r,items:t});if(s.data.boardBySlug)return s.data.boardBySlug;throw new Error(`UserError: ${e} is not a board. Please query boards on Replit.`)}async boardPosts(e="",t=5,r=""){const{slug:s}=this,a={boardBySlug:{args:[{slug:"slug"}],items:{posts:{args:[{count:"count",after:"after",order:"order"}],items:{items:{args:[],items:{id:"",title:"",preview:[{propOverride:!0,length:g.initVariables.markdown.length||150,removeMarkdown:g.initVariables.markdown.removeMarkdown||!0}]}}}}}}},i={slug:["String!",s],after:["String!",e],count:["Int!",t],order:["String!",r]},n=await this.runGraphQL({name:"BoardData",variables:i,items:a});if(n.data.boardBySlug)return n.data.boardBySlug.posts.items;throw new Error(`UserError: ${s} is not a board. Please query boards on Replit.`)}},Explore:class extends w{constructor(e){super(),this.tag=e}async exploreFeaturedRepls(){const e={featuredRepls:{args:[],items:{...g.replAttributes}}},t=await this.runGraphQL({name:"ExploreFeaturedRepls",variables:{},items:e});if(t.data.featuredRepls)return t.data.featuredRepls;throw new Error("UserError: Cannot fetch explore featured repls.")}async exploreTrendingTags(){const e=await this.runGraphQL({name:"ExploreTrendingTags",variables:{},items:{trendingTagsFeed:{args:[],items:{tags:""}}}});if(e.data.trendingTagsFeed)return e.data.trendingTagsFeed;throw new Error("UserError: Cannot fetch explore trending tags.")}async exploreTagData(){const{tag:e}=this,t={tag:{args:[{id:"id"}],items:{...g.tagAttributes}}},r={id:["String!",e]},s=await this.runGraphQL({name:"ExploreTagData",variables:r,items:t});if(s.data.tag)return s.data.tag;throw new Error("UserError: Cannot fetch explore tag data.")}async exploreTagTrendingRepls(){const{tag:e}=this,t={tag:{args:[{id:"id"}],items:{trendingRepls:{args:[],items:{...g.replAttributes}}}}},r={id:["String!",e]},s=await this.runGraphQL({name:"ExploreTagTrendingRepls",variables:r,items:t});if(s.data.tag)return s.data.tag;throw new Error("UserError: Cannot fetch explore tag repls.")}async exploreTagTrendingReplsFeed(){const{tag:e}=this,t={id:["String!",e]},r=await this.runGraphQL({name:"ExploreTagTrendingReplsFeed",variables:t,items:{tag:{args:[{id:"id"}],items:{trendingReplsFeed:{args:[],items:{replIds:""}}}}}});if(r.data.tag)return r.data.tag;throw new Error("UserError: Cannot fetch explore tag repls feed.")}},Languages:class{constructor(e){this.lang=e}async langData(){return(await y())[this.lang]}async langDataAll(){return await y()}}};Object.prototype.sortKeys=function(){return Object.fromEntries(Object.entries(this).sort())};const R={username:"",captcha:{token:""},endpoints:{gql:"",restful:"",login:""},markdown:{length:"",removeMarkdown:""},previewCount:{comments:""},experimentalFeatures:"",createDatabaseFlag:"",statsForNerds:""};function S(t,s=".json"){switch(t&&a(R,t),s){case".json":e.writeFileSync(r.join(process.cwd(),".replapirc.json"),`${JSON.stringify(R.sortKeys(),null,"\t")}\n`,{encoding:"utf8"});break;case".mjs":e.writeFileSync(r.join(process.cwd(),"replapi.config.mjs"),`export default ${JSON.stringify(R.sortKeys(),null,"\t")}\n`,{encoding:"utf8"});break;case".cjs":e.writeFileSync(r.join(process.cwd(),"replapi.config.cjs"),`module.exports = ${JSON.stringify(R.sortKeys(),null,"\t")}\n`,{encoding:"utf8"});break;case".js":e.writeFileSync(r.join(process.cwd(),"replapi.config.js"),`module.exports = ${JSON.stringify(R.sortKeys(),null,"\t")}\n`,{encoding:"utf8"});break;default:console.warn(`Invalid file type '${s}'`),e.writeFileSync(r.join(process.cwd(),".replapirc.json"),`${JSON.stringify(R.sortKeys(),null,"\t")}\n`,{encoding:"utf8"})}return{defaults:R,Blog:E.Blog,Board:E.Board,Explore:E.Explore,User:E.User,Languages:E.Languages}}export default S;
